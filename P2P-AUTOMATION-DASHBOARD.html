<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Automation Dashboard | USDT Arbitrage Bot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .status-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .status-card h3 {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .status-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .status-card.online .value { color: #27ae60; }
        .status-card.pending .value { color: #f39c12; }
        .status-card.error .value { color: #e74c3c; }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .control-panel {
            grid-column: 1 / -1;
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .order-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .order-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .order-item:hover {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .order-id {
            font-weight: bold;
            color: #2c3e50;
        }

        .order-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-waiting_payment { background: #d1ecf1; color: #0c5460; }
        .status-paid { background: #d4edda; color: #155724; }
        .status-completed { background: #d1ecf1; color: #0c5460; }
        .status-cancelled { background: #f8d7da; color: #721c24; }

        .order-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            font-size: 0.9rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-weight: bold;
            color: #666;
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .detail-value {
            color: #2c3e50;
            font-weight: 500;
        }

        .log-container {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-timestamp {
            color: #95a5a6;
            margin-right: 10px;
        }

        .log-level {
            font-weight: bold;
            margin-right: 10px;
        }

        .log-info { color: #3498db; }
        .log-success { color: #27ae60; }
        .log-warning { color: #f39c12; }
        .log-error { color: #e74c3c; }

        .config-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .form-group input, .form-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left-color: #17a2b8;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left-color: #ffc107;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ P2P Automation Dashboard</h1>
            <p>Complete USDT Arbitrage Workflow Automation System</p>
        </div>

        <!-- System Status Bar -->
        <div class="status-bar">
            <div class="status-card online">
                <h3>System Status</h3>
                <div class="value" id="systemStatus">üü¢ ONLINE</div>
            </div>
            <div class="status-card">
                <h3>Active Orders</h3>
                <div class="value" id="activeOrders">0</div>
            </div>
            <div class="status-card">
                <h3>Pending Releases</h3>
                <div class="value" id="pendingReleases">0</div>
            </div>
            <div class="status-card">
                <h3>Total Processed</h3>
                <div class="value" id="totalProcessed">‚Çπ0</div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="card control-panel">
            <h2>üéõÔ∏è Control Panel</h2>
            <div class="btn-group">
                <button class="btn btn-success" onclick="startWorkflow()">
                    ‚ñ∂Ô∏è Start Automation
                </button>
                <button class="btn btn-warning" onclick="pauseWorkflow()">
                    ‚è∏Ô∏è Pause Automation
                </button>
                <button class="btn btn-danger" onclick="stopWorkflow()">
                    ‚èπÔ∏è Stop Automation
                </button>
                <button class="btn btn-primary" onclick="testPaymentDetection()">
                    üß™ Test Payment Detection
                </button>
                <button class="btn btn-primary" onclick="refreshData()">
                    üîÑ Refresh Data
                </button>
                <button class="btn btn-primary" onclick="createTestOrder()">
                    üìù Create Test Order
                </button>
            </div>
            
            <div id="alertContainer"></div>
        </div>

        <div class="main-grid">
            <!-- Active Orders -->
            <div class="card">
                <h2>üìã Active Orders</h2>
                <div class="order-list" id="ordersList">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        No active orders
                    </div>
                </div>
            </div>

            <!-- Payment Monitoring -->
            <div class="card">
                <h2>üí∞ Payment Monitoring</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="gmailStatus">üî¥</div>
                        <div class="stat-label">Gmail Monitor</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="smsStatus">üî¥</div>
                        <div class="stat-label">SMS Monitor</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="paymentsDetected">0</div>
                        <div class="stat-label">Payments Detected</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="verificationsSuccess">0</div>
                        <div class="stat-label">Verified</div>
                    </div>
                </div>
            </div>

            <!-- Auto-Release Status -->
            <div class="card">
                <h2>üöÄ Auto-Release System</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="autoReleaseStatus">üî¥</div>
                        <div class="stat-label">Status</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="releasesCompleted">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="releasesFailed">0</div>
                        <div class="stat-label">Failed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avgReleaseTime">0s</div>
                        <div class="stat-label">Avg Time</div>
                    </div>
                </div>
            </div>

            <!-- Configuration -->
            <div class="card">
                <h2>‚öôÔ∏è Configuration</h2>
                <div class="config-form">
                    <div class="form-group">
                        <label>Min Confidence</label>
                        <input type="number" id="minConfidence" value="0.9" step="0.1" min="0" max="1">
                    </div>
                    <div class="form-group">
                        <label>Max Auto Amount (‚Çπ)</label>
                        <input type="number" id="maxAutoAmount" value="50000" step="1000">
                    </div>
                    <div class="form-group">
                        <label>Release Delay (seconds)</label>
                        <input type="number" id="releaseDelay" value="30" step="5" min="0">
                    </div>
                    <div class="form-group">
                        <label>Default Payment Method</label>
                        <select id="paymentMethod">
                            <option value="UPI">UPI</option>
                            <option value="IMPS">IMPS</option>
                            <option value="NEFT">NEFT</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="updateConfig()" style="margin-top: 15px;">
                    üíæ Update Configuration
                </button>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="card">
            <h2>üìú Activity Log</h2>
            <div class="log-container" id="activityLog">
                <div class="log-entry">
                    <span class="log-timestamp">[00:00:00]</span>
                    <span class="log-level log-info">[INFO]</span>
                    P2P Automation Dashboard initialized
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let workflowStatus = {
            running: false,
            gmailMonitor: false,
            smsMonitor: false,
            autoRelease: false
        };

        let stats = {
            activeOrders: 0,
            pendingReleases: 0,
            totalProcessed: 0,
            paymentsDetected: 0,
            verificationsSuccess: 0,
            releasesCompleted: 0,
            releasesFailed: 0
        };

        let orders = [];
        let logEntries = [];

        // Initialize dashboard
        function init() {
            log('info', 'P2P Automation Dashboard initialized');
            updateStatusDisplay();
            refreshData();
            
            // Auto-refresh every 10 seconds
            setInterval(refreshData, 10000);
        }

        // Logging function
        function log(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = {
                timestamp,
                level,
                message
            };
            
            logEntries.unshift(entry);
            if (logEntries.length > 50) logEntries.pop();
            
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logContainer = document.getElementById('activityLog');
            logContainer.innerHTML = logEntries.map(entry => `
                <div class="log-entry">
                    <span class="log-timestamp">[${entry.timestamp}]</span>
                    <span class="log-level log-${entry.level}">[${entry.level.toUpperCase()}]</span>
                    ${entry.message}
                </div>
            `).join('');
        }

        function updateStatusDisplay() {
            // System status
            document.getElementById('systemStatus').textContent = 
                workflowStatus.running ? 'üü¢ ONLINE' : 'üî¥ OFFLINE';
            
            // Stats
            document.getElementById('activeOrders').textContent = stats.activeOrders;
            document.getElementById('pendingReleases').textContent = stats.pendingReleases;
            document.getElementById('totalProcessed').textContent = `‚Çπ${stats.totalProcessed.toLocaleString()}`;
            
            // Payment monitoring
            document.getElementById('gmailStatus').textContent = workflowStatus.gmailMonitor ? 'üü¢' : 'üî¥';
            document.getElementById('smsStatus').textContent = workflowStatus.smsMonitor ? 'üü¢' : 'üî¥';
            document.getElementById('paymentsDetected').textContent = stats.paymentsDetected;
            document.getElementById('verificationsSuccess').textContent = stats.verificationsSuccess;
            
            // Auto-release
            document.getElementById('autoReleaseStatus').textContent = workflowStatus.autoRelease ? 'üü¢' : 'üî¥';
            document.getElementById('releasesCompleted').textContent = stats.releasesCompleted;
            document.getElementById('releasesFailed').textContent = stats.releasesFailed;
        }

        function updateOrdersDisplay() {
            const ordersList = document.getElementById('ordersList');
            
            if (orders.length === 0) {
                ordersList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No active orders</div>';
                return;
            }
            
            ordersList.innerHTML = orders.map(order => `
                <div class="order-item">
                    <div class="order-header">
                        <span class="order-id">${order.id}</span>
                        <span class="order-status status-${order.status}">${order.status}</span>
                    </div>
                    <div class="order-details">
                        <div class="detail-item">
                            <span class="detail-label">Exchange</span>
                            <span class="detail-value">${order.exchange}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Amount</span>
                            <span class="detail-value">${order.amount} USDT</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Price</span>
                            <span class="detail-value">‚Çπ${order.price}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Expected</span>
                            <span class="detail-value">‚Çπ${(order.amount * order.price).toLocaleString()}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Created</span>
                            <span class="detail-value">${new Date(order.createdAt).toLocaleTimeString()}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Actions</span>
                            <span class="detail-value">
                                <button class="btn btn-sm btn-success" onclick="manualRelease('${order.id}')">Release</button>
                                <button class="btn btn-sm btn-danger" onclick="cancelOrder('${order.id}')">Cancel</button>
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showAlert(type, message) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Control functions
        async function startWorkflow() {
            log('info', 'Starting P2P automation workflow...');
            
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                workflowStatus.running = true;
                workflowStatus.gmailMonitor = true;
                workflowStatus.smsMonitor = true;
                workflowStatus.autoRelease = true;
                
                updateStatusDisplay();
                showAlert('success', 'P2P automation workflow started successfully');
                log('success', 'P2P automation workflow started');
            } catch (error) {
                log('error', `Failed to start workflow: ${error.message}`);
                showAlert('error', 'Failed to start workflow');
            }
        }

        async function pauseWorkflow() {
            log('info', 'Pausing automation workflow...');
            
            workflowStatus.autoRelease = false;
            updateStatusDisplay();
            showAlert('warning', 'Automation paused - manual intervention required');
            log('warning', 'Automation workflow paused');
        }

        async function stopWorkflow() {
            log('info', 'Stopping P2P automation workflow...');
            
            workflowStatus.running = false;
            workflowStatus.gmailMonitor = false;
            workflowStatus.smsMonitor = false;
            workflowStatus.autoRelease = false;
            
            updateStatusDisplay();
            showAlert('info', 'P2P automation workflow stopped');
            log('info', 'P2P automation workflow stopped');
        }

        async function testPaymentDetection() {
            log('info', 'Testing payment detection system...');
            
            try {
                // Simulate payment detection test
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                stats.paymentsDetected++;
                stats.verificationsSuccess++;
                
                updateStatusDisplay();
                showAlert('success', 'Payment detection test completed successfully');
                log('success', 'Test payment detected and verified (‚Çπ25,000)');
            } catch (error) {
                log('error', `Payment detection test failed: ${error.message}`);
                showAlert('error', 'Payment detection test failed');
            }
        }

        async function createTestOrder() {
            log('info', 'Creating test P2P order...');
            
            try {
                const testOrder = {
                    id: `test_${Date.now()}`,
                    exchange: 'Binance',
                    type: 'sell',
                    amount: 100,
                    price: 84.50,
                    currency: 'USDT',
                    status: 'waiting_payment',
                    createdAt: new Date().toISOString(),
                    paymentMethod: 'UPI'
                };
                
                orders.unshift(testOrder);
                stats.activeOrders++;
                
                updateStatusDisplay();
                updateOrdersDisplay();
                showAlert('success', 'Test order created successfully');
                log('success', `Test order created: ${testOrder.id}`);
            } catch (error) {
                log('error', `Failed to create test order: ${error.message}`);
                showAlert('error', 'Failed to create test order');
            }
        }

        async function manualRelease(orderId) {
            log('info', `Manually releasing order: ${orderId}`);
            
            try {
                const response = await fetch(`http://localhost:3001/api/p2p/orders/${orderId}/release`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: 'Manual release from dashboard' })
                });
                
                if (response.ok) {
                    log('success', `Order ${orderId} released successfully`);
                    showAlert('success', 'Order released successfully');
                    refreshData(); // Refresh to show updated status
                } else {
                    const error = await response.json();
                    log('error', `Release failed: ${error.error}`);
                    showAlert('error', `Release failed: ${error.error}`);
                }
            } catch (error) {
                    orders[orderIndex].status = 'completed';
                    stats.activeOrders--;
                    stats.releasesCompleted++;
                    stats.totalProcessed += orders[orderIndex].amount * orders[orderIndex].price;
                    
                    setTimeout(() => {
                        orders.splice(orderIndex, 1);
                        updateOrdersDisplay();
                    }, 2000);
                    
                    updateStatusDisplay();
                    updateOrdersDisplay();
                    showAlert('success', `Order ${orderId} released manually`);
                    log('success', `Manual release completed for order: ${orderId}`);
                }
            } catch (error) {
                log('error', `Manual release failed: ${error.message}`);
                showAlert('error', 'Manual release failed');
            }
        }

        async function cancelOrder(orderId) {
            log('info', `Cancelling order: ${orderId}`);
            
            try {
                const response = await fetch(`http://localhost:3001/api/p2p/orders/${orderId}/cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    log('success', `Order ${orderId} cancelled successfully`);
                    showAlert('success', 'Order cancelled successfully');
                    refreshData(); // Refresh to show updated status
                } else {
                    const error = await response.json();
                    log('error', `Cancel failed: ${error.error}`);
                    showAlert('error', `Cancel failed: ${error.error}`);
                }
            } catch (error) {
                    orders[orderIndex].status = 'cancelled';
                    stats.activeOrders--;
                    
                    setTimeout(() => {
                        orders.splice(orderIndex, 1);
                        updateOrdersDisplay();
                    }, 2000);
                    
                    updateStatusDisplay();
                    updateOrdersDisplay();
                    showAlert('warning', `Order ${orderId} cancelled`);
                    log('warning', `Order cancelled: ${orderId}`);
                }
            } catch (error) {
                log('error', `Order cancellation failed: ${error.message}`);
                showAlert('error', 'Order cancellation failed');
            }
        }

        async function updateConfig() {
            log('info', 'Updating automation configuration...');
            
            const config = {
                minConfidence: document.getElementById('minConfidence').value,
                maxAutoAmount: document.getElementById('maxAutoAmount').value,
                releaseDelay: document.getElementById('releaseDelay').value,
                paymentMethod: document.getElementById('paymentMethod').value
            };
            
            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 500));
            
            showAlert('success', 'Configuration updated successfully');
            log('success', `Configuration updated: ${JSON.stringify(config)}`);
        }

        async function refreshData() {
            try {
                // Fetch real data from API
                const ordersResponse = await fetch('http://localhost:3001/api/p2p/orders');
                if (ordersResponse.ok) {
                    const ordersData = await ordersResponse.json();
                    orders = ordersData.orders || [];
                    stats.activeOrders = orders.length;
                    
                    // Update orders display
                    updateOrdersDisplay();
                    log('info', `Refreshed: ${orders.length} active orders`);
                } else {
                    log('error', 'Failed to fetch orders from API');
                }
                
                // Fetch system status
                const statusResponse = await fetch('http://localhost:3001/api/system/status');
                if (statusResponse.ok) {
                    const statusData = await statusResponse.json();
                    workflowStatus.running = statusData.status?.orchestrator?.running || false;
                    workflowStatus.autoRelease = statusData.status?.autoRelease?.enabled || false;
                    
                    updateStatusDisplay();
                }
            } catch (error) {
                log('error', `API connection failed: ${error.message}`);
                // Fallback simulation for demo
                if (workflowStatus.running) {
                    if (Math.random() < 0.1) {
                        stats.paymentsDetected++;
                        log('info', `Payment detected via ${Math.random() < 0.5 ? 'Gmail' : 'SMS'}`);
                    }
                    
                    if (Math.random() < 0.05) {
                        stats.verificationsSuccess++;
                    log('success', 'Payment verification completed');
                }
            }
            
            updateStatusDisplay();
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>