<!DOCTYPE html>
<html>
<head>
    <title>üöÄ Live Arbitrage Testing Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e1f;
            color: #e2e8f0;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(236, 72, 153, 0.3);
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1e293b;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #334155;
            padding: 10px 20px;
            border-radius: 25px;
        }
        .live-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        .card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }
        .card-title {
            font-size: 1.3em;
            color: #ec4899;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .opportunity-card {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            border: 2px solid #10b981;
            animation: opportunity-glow 3s infinite;
        }
        @keyframes opportunity-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
            50% { box-shadow: 0 0 40px rgba(16, 185, 129, 0.6); }
        }
        .alert-card {
            background: linear-gradient(135deg, #7c2d12 0%, #dc2626 100%);
            border: 2px solid #ef4444;
            animation: alert-flash 2s infinite;
        }
        @keyframes alert-flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #334155;
        }
        th {
            background: #0f172a;
            color: #ec4899;
            font-weight: 600;
        }
        .price-up {
            color: #10b981;
            font-weight: bold;
        }
        .price-down {
            color: #ef4444;
            font-weight: bold;
        }
        .profit-badge {
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .high-profit {
            background: #f59e0b;
            animation: profit-flash 1s infinite;
        }
        @keyframes profit-flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        button {
            background: #ec4899;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }
        button:hover {
            background: #be185d;
            transform: translateY(-2px);
        }
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .metric-card {
            background: #0f172a;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #334155;
            margin: 10px 0;
        }
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #ec4899;
            margin-bottom: 5px;
        }
        .metric-label {
            color: #94a3b8;
            font-size: 0.9em;
        }
        .log-container {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #334155;
            padding-left: 10px;
        }
        .log-success {
            border-left-color: #10b981;
            color: #34d399;
        }
        .log-warning {
            border-left-color: #f59e0b;
            color: #fbbf24;
        }
        .log-error {
            border-left-color: #ef4444;
            color: #fca5a5;
        }
        .telegram-preview {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .telegram-header {
            color: #0088cc;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .countdown {
            font-size: 1.2em;
            font-weight: bold;
            color: #f59e0b;
        }
        .trading-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .action-button {
            background: #059669;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-size: 1em;
        }
        .action-button:hover {
            background: #047857;
            transform: scale(1.05);
        }
        .action-button.danger {
            background: #dc2626;
        }
        .action-button.danger:hover {
            background: #b91c1c;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Live Arbitrage Testing Dashboard</h1>
            <p>Real-time monitoring and execution of USDT arbitrage opportunities</p>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="live-indicator"></div>
                <span>System Status: <span id="systemStatus">Monitoring</span></span>
            </div>
            <div class="status-item">
                <span>‚è±Ô∏è Runtime: <span id="runtime">00:00:00</span></span>
            </div>
            <div class="status-item">
                <span>üîÑ Next Scan: <span id="nextScan" class="countdown">30s</span></span>
            </div>
            <div class="status-item">
                <span>üìä Opportunities Found: <span id="opportunityCount">0</span></span>
            </div>
            <div class="status-item">
                <span>üì± Telegram: <span id="telegramStatus">Connected</span></span>
            </div>
        </div>

        <div class="card alert-card" style="margin-bottom: 20px;">
            <div class="card-title">‚ö†Ô∏è Platform Status Alert (Updated July 2025)</div>
            <p><strong>‚ùå Unavailable in India:</strong> OKX (ceased operations 2024), Bybit (suspended Jan 2025), Binance P2P (severely restricted)</p>
            <p><strong>üü° WazirX:</strong> Resuming Feb 2025 after security breach recovery</p>
            <p><strong>‚úÖ Active Exchanges:</strong> CoinDCX, Giottus, CoinSwitch, ZebPay, Bitbns</p>
            <p><strong>‚úÖ Active P2P:</strong> Local P2P trading, CoinDCX P2P, ZebPay P2P</p>
        </div>

        <div class="controls">
            <button onclick="startMonitoring()">‚ñ∂Ô∏è Start Monitoring</button>
            <button onclick="stopMonitoring()">‚è∏Ô∏è Stop Monitoring</button>
            <button onclick="manualScan()">üîç Manual Scan</button>
            <button onclick="testTelegram()">üì± Test Telegram</button>
            <button onclick="showTelegramConfig()">‚öôÔ∏è Telegram Settings</button>
            <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
        </div>

        <!-- Telegram Configuration Modal -->
        <div id="telegramConfigModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e293b; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px;">
                <h3 style="color: #ec4899; margin-bottom: 20px;">üì± Telegram Configuration</h3>
                
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px; color: #94a3b8;">Bot Token:</label>
                    <input type="text" id="botTokenInput" placeholder="Bot Token from @BotFather" style="width: 100%; padding: 10px; background: #334155; border: 1px solid #475569; border-radius: 6px; color: white; box-sizing: border-box;">
                </div>
                
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px; color: #94a3b8;">Chat ID:</label>
                    <input type="text" id="chatIdInput" placeholder="Your Chat ID" style="width: 100%; padding: 10px; background: #334155; border: 1px solid #475569; border-radius: 6px; color: white; box-sizing: border-box;">
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="saveTelegramConfig()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; margin-right: 10px; cursor: pointer;">üíæ Save</button>
                    <button onclick="closeTelegramConfig()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">‚ùå Cancel</button>
                </div>
                
                <div style="background: #1e3a8a; padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 0.9em;">
                    <strong>üí° Quick Setup:</strong><br>
                    1. Message @BotFather on Telegram<br>
                    2. Create new bot with /newbot<br>
                    3. Get your Chat ID from @userinfobot<br>
                    4. Paste both values above
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card opportunity-card" id="bestOpportunity" style="display: none;">
                <div class="card-title">üéØ Best Opportunity</div>
                <div class="metric-card">
                    <div class="metric-value" id="bestProfit">0%</div>
                    <div class="metric-label">Net Profit</div>
                </div>
                <div id="opportunityDetails">
                    <p><strong>Route:</strong> <span id="bestRoute">-</span></p>
                    <p><strong>Volume:</strong> <span id="bestVolume">-</span></p>
                    <p><strong>Profit:</strong> <span id="bestProfitAmount">-</span></p>
                </div>
                <div class="trading-actions">
                    <button class="action-button" onclick="executeOpportunity()">
                        ‚ö° Execute Trade
                    </button>
                    <button class="action-button" onclick="simulateOpportunity()">
                        üß™ Simulate
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìä Live Exchange Rates</div>
                <table>
                    <thead>
                        <tr>
                            <th>Exchange</th>
                            <th>Price</th>
                            <th>Change</th>
                        </tr>
                    </thead>
                    <tbody id="exchangeRates">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <div class="card">
                <div class="card-title">üí∞ P2P Premium Tracker</div>
                <div id="p2pPremiums">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <div class="card-title">üèÜ Top Opportunities</div>
                <table>
                    <thead>
                        <tr>
                            <th>Route</th>
                            <th>Profit</th>
                            <th>Volume</th>
                        </tr>
                    </thead>
                    <tbody id="topOpportunities">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <div class="card">
                <div class="card-title">üìà Performance Metrics</div>
                <div class="metric-card">
                    <div class="metric-value" id="totalScans">0</div>
                    <div class="metric-label">Total Scans</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgProfit">0%</div>
                    <div class="metric-label">Average Profit</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="successRate">0%</div>
                    <div class="metric-label">Success Rate</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üì± Telegram Preview</div>
                <div class="telegram-preview" id="telegramPreview">
                    <div class="telegram-header">ü§ñ USDT Arbitrage Bot</div>
                    <div>No recent alerts</div>
                </div>
                <button onclick="sendTestAlert()">Send Test Alert</button>
                <button onclick="debugTelegram()">üîß Debug Telegram</button>
            </div>
        </div>

        <div class="card">
            <div class="card-title">üìù Activity Log</div>
            <div class="log-container" id="activityLog">
                <div class="log-entry">System initialized. Ready for monitoring.</div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let isMonitoring = false;
        let scanInterval = null;
        let countdownInterval = null;
        let runtimeInterval = null;
        let startTime = null;
        let scanCount = 0;
        let opportunityCount = 0;
        let countdownSeconds = 30;
        let currentOpportunities = [];
        
        // Global Telegram config that can be updated
        // IMPORTANT: Set your credentials here or via the UI
        let telegramConfig = {
            botToken: '',  // Get from @BotFather on Telegram
            chatId: ''     // Get by messaging @userinfobot
        };

        // Exchange data with current rates and status
        const exchangeData = {
            'CoinDCX': { price: 87.48, change: 0, status: 'active', reliability: 'high' },
            'WazirX': { price: 86.74, change: 0, status: 'halted', reliability: 'low' },
            'Giottus': { price: 88.67, change: 0, status: 'active', reliability: 'high' },
            'CoinSwitch': { price: 87.93, change: 0, status: 'active', reliability: 'medium' },
            'ZebPay': { price: 89.15, change: 0, status: 'active', reliability: 'high' }
        };

        // P2P platforms (Only India-available platforms)
        const p2pData = {
            'WazirX P2P': { premium: 1.8, merchants: 23, status: 'resuming' },
            'CoinDCX P2P': { premium: 2.2, merchants: 45, status: 'active' },
            'ZebPay P2P': { premium: 2.5, merchants: 34, status: 'active' },
            'Local P2P': { premium: 3.0, merchants: 156, status: 'active' }
        };

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('activityLog');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // Keep only last 50 entries
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        function updateRuntime() {
            if (!startTime) return;
            
            const now = Date.now();
            const elapsed = now - startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            document.getElementById('runtime').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateCountdown() {
            if (!isMonitoring) return;
            
            countdownSeconds--;
            if (countdownSeconds <= 0) {
                countdownSeconds = 30;
                performScan();
            }
            
            document.getElementById('nextScan').textContent = `${countdownSeconds}s`;
        }

        function performScan() {
            scanCount++;
            addLog(`Performing scan #${scanCount}`, 'info');
            
            // Simulate price updates
            updateExchangeRates();
            updateP2PPremiums();
            
            // Find opportunities
            const opportunities = findOpportunities();
            
            if (opportunities.length > 0) {
                opportunityCount++;
                const best = opportunities[0];
                
                if (best.profit > 2) {
                    addLog(`HIGH PROFIT OPPORTUNITY: ${best.route} - ${best.profit}% profit!`, 'success');
                    showBestOpportunity(best);
                    sendTelegramAlert(best);
                } else {
                    addLog(`Opportunity found: ${best.route} - ${best.profit}% profit`, 'success');
                    showBestOpportunity(best);
                }
            } else {
                addLog('No profitable opportunities found', 'warning');
                hideBestOpportunity();
            }
            
            updateTopOpportunities(opportunities);
            updateMetrics();
            
            document.getElementById('totalScans').textContent = scanCount;
            document.getElementById('opportunityCount').textContent = opportunityCount;
        }

        function updateExchangeRates() {
            const tableBody = document.getElementById('exchangeRates');
            tableBody.innerHTML = '';
            
            for (const [exchange, data] of Object.entries(exchangeData)) {
                // Add random price variation only for active exchanges
                if (data.status === 'active') {
                    const oldPrice = data.price;
                    const variation = (Math.random() - 0.5) * 0.5;
                    data.price = Math.max(85, Math.min(92, data.price + variation));
                    data.change = ((data.price - oldPrice) / oldPrice) * 100;
                }
                
                const statusColor = data.status === 'active' ? '#10b981' : '#ef4444';
                const statusText = data.status === 'active' ? 'Active' : 'HALTED';
                
                const row = `
                    <tr style="${data.status === 'halted' ? 'opacity: 0.5;' : ''}">
                        <td>
                            ${exchange}
                            <div style="font-size: 0.8em; color: ${statusColor}; font-weight: bold;">
                                ${statusText}
                            </div>
                        </td>
                        <td>‚Çπ${data.price.toFixed(2)}</td>
                        <td class="${data.change >= 0 ? 'price-up' : 'price-down'}">
                            ${data.status === 'active' ? 
                                `${data.change >= 0 ? '+' : ''}${data.change.toFixed(2)}%` : 
                                'N/A'
                            }
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            }
        }

        function updateP2PPremiums() {
            const container = document.getElementById('p2pPremiums');
            let html = '';
            
            for (const [platform, data] of Object.entries(p2pData)) {
                // Add random premium variation
                data.premium += (Math.random() - 0.5) * 0.5;
                data.premium = Math.max(0.5, Math.min(6, data.premium));
                
                html += `
                    <div class="metric-card">
                        <div class="metric-value" style="font-size: 1.5em;">${data.premium.toFixed(1)}%</div>
                        <div class="metric-label">${platform}</div>
                        <div style="font-size: 0.8em; color: #94a3b8;">${data.merchants} merchants</div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function findOpportunities() {
            const opportunities = [];
            
            // Find cheapest ACTIVE exchange only
            let cheapestExchange = '';
            let cheapestPrice = Infinity;
            
            for (const [exchange, data] of Object.entries(exchangeData)) {
                if (data.status === 'active' && data.price < cheapestPrice) {
                    cheapestPrice = data.price;
                    cheapestExchange = exchange;
                }
            }
            
            // Skip if no active exchanges found
            if (!cheapestExchange) {
                addLog('No active exchanges available for trading', 'error');
                return [];
            }
            
            // Calculate opportunities with P2P platforms
            for (const [platform, data] of Object.entries(p2pData)) {
                const sellPrice = cheapestPrice * (1 + data.premium / 100);
                const profit = calculateNetProfit(cheapestPrice, sellPrice);
                
                if (profit > 0.5) {
                    opportunities.push({
                        route: `${cheapestExchange} ‚Üí ${platform}`,
                        buyPrice: cheapestPrice,
                        sellPrice: sellPrice,
                        profit: profit,
                        volume: 49000,
                        profitAmount: (profit * 49000 / 100).toFixed(0),
                        exchangeStatus: exchangeData[cheapestExchange].status,
                        reliability: exchangeData[cheapestExchange].reliability
                    });
                }
            }
            
            // CRITICAL FIX: Store opportunities globally for metrics
            currentOpportunities = opportunities;
            
            return opportunities.sort((a, b) => b.profit - a.profit);
        }

        function calculateNetProfit(buyPrice, sellPrice) {
            const investment = 49000;
            const fees = investment * 0.003; // 0.3% total fees
            const grossProfit = (sellPrice - buyPrice) * (investment / buyPrice);
            const netProfit = grossProfit - fees;
            const tax = netProfit * 0.30;
            const finalProfit = netProfit - tax;
            
            return (finalProfit / investment) * 100;
        }

        function showBestOpportunity(opportunity) {
            document.getElementById('bestOpportunity').style.display = 'block';
            document.getElementById('bestProfit').textContent = `${opportunity.profit.toFixed(2)}%`;
            document.getElementById('bestRoute').textContent = opportunity.route;
            document.getElementById('bestVolume').textContent = `‚Çπ${opportunity.volume.toLocaleString('en-IN')}`;
            document.getElementById('bestProfitAmount').textContent = `‚Çπ${opportunity.profitAmount}`;
        }

        function hideBestOpportunity() {
            document.getElementById('bestOpportunity').style.display = 'none';
        }

        function updateTopOpportunities(opportunities) {
            const tableBody = document.getElementById('topOpportunities');
            tableBody.innerHTML = '';
            
            opportunities.slice(0, 5).forEach(opp => {
                const row = `
                    <tr>
                        <td>${opp.route}</td>
                        <td><span class="profit-badge ${opp.profit > 2 ? 'high-profit' : ''}">${opp.profit.toFixed(2)}%</span></td>
                        <td>‚Çπ${opp.volume.toLocaleString('en-IN')}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        function updateMetrics() {
            const avgProfit = currentOpportunities.length > 0 
                ? currentOpportunities.reduce((sum, opp) => sum + opp.profit, 0) / currentOpportunities.length
                : 0;
            
            document.getElementById('avgProfit').textContent = `${avgProfit.toFixed(2)}%`;
            document.getElementById('successRate').textContent = `${((opportunityCount / scanCount) * 100).toFixed(1)}%`;
        }

        async function sendTelegramAlert(opportunity) {
            // Update preview first
            const preview = document.getElementById('telegramPreview');
            preview.innerHTML = `
                <div class="telegram-header">ü§ñ USDT Arbitrage Bot</div>
                <div>üö® <strong>HIGH PROFIT ALERT!</strong></div>
                <div>Route: ${opportunity.route}</div>
                <div>Profit: ${opportunity.profit.toFixed(2)}%</div>
                <div>Amount: ‚Çπ${opportunity.profitAmount}</div>
                <div>Time: ${new Date().toLocaleTimeString()}</div>
            `;

            // Use global Telegram config
            const botToken = telegramConfig.botToken;
            const chatId = telegramConfig.chatId;
            
            const message = `üö® <b>HIGH PROFIT ALERT!</b>

<b>üéØ Arbitrage Opportunity Found</b>

<b>Route:</b> ${opportunity.route}
<b>Profit:</b> ${opportunity.profit.toFixed(2)}%
<b>Amount:</b> ‚Çπ${opportunity.profitAmount}
<b>Volume:</b> ‚Çπ${opportunity.volume?.toLocaleString('en-IN') || '49,000'}

<b>‚ö° Action Required:</b>
Execute within 15 minutes!

<b>Recommendation:</b>
1. Buy USDT on ${opportunity.route.split(' ‚Üí ')[0]}
2. Sell on ${opportunity.route.split(' ‚Üí ')[1]}
3. Keep transaction under ‚Çπ50k (TDS optimized)

<i>Generated: ${new Date().toLocaleString()}</i>`;

            try {
                addLog('Sending Telegram alert...', 'info');
                addLog(`Using Bot Token: ${botToken.substring(0, 10)}...`, 'info');
                addLog(`Chat ID: ${chatId}`, 'info');
                
                const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        parse_mode: 'HTML'
                    })
                });
                
                const data = await response.json();
                addLog(`Telegram API Response: ${JSON.stringify(data)}`, 'info');
                
                if (data.ok) {
                    addLog('‚úÖ Telegram alert sent successfully!', 'success');
                    document.getElementById('telegramStatus').textContent = 'Connected ‚úÖ';
                    document.getElementById('telegramStatus').style.color = '#10b981';
                } else {
                    addLog(`‚ùå Telegram API error: ${data.description || 'Unknown error'}`, 'error');
                    document.getElementById('telegramStatus').textContent = 'Error ‚ùå';
                    document.getElementById('telegramStatus').style.color = '#ef4444';
                }
            } catch (error) {
                addLog(`‚ùå Network/Fetch error: ${error.message}`, 'error');
                addLog('Check your internet connection and bot credentials', 'warning');
                document.getElementById('telegramStatus').textContent = 'Failed ‚ùå';
                document.getElementById('telegramStatus').style.color = '#ef4444';
            }
        }

        function startMonitoring() {
            if (isMonitoring) return;
            
            isMonitoring = true;
            startTime = Date.now();
            countdownSeconds = 30;
            
            document.getElementById('systemStatus').textContent = 'Active';
            
            // Start intervals
            scanInterval = setInterval(performScan, 30000);
            countdownInterval = setInterval(updateCountdown, 1000);
            runtimeInterval = setInterval(updateRuntime, 1000);
            
            // Initial scan
            performScan();
            
            addLog('Monitoring started', 'success');
        }

        function stopMonitoring() {
            isMonitoring = false;
            
            if (scanInterval) clearInterval(scanInterval);
            if (countdownInterval) clearInterval(countdownInterval);
            if (runtimeInterval) clearInterval(runtimeInterval);
            
            document.getElementById('systemStatus').textContent = 'Stopped';
            document.getElementById('nextScan').textContent = 'Stopped';
            
            addLog('Monitoring stopped', 'warning');
        }

        function manualScan() {
            if (!isMonitoring) {
                addLog('Manual scan initiated', 'info');
                performScan();
            }
        }

        async function testTelegram() {
            addLog('Testing Telegram connection...', 'info');
            
            const botToken = telegramConfig.botToken;
            const chatId = telegramConfig.chatId;
            
            const message = `üîß <b>TELEGRAM CONNECTION TEST</b>

‚úÖ Your Telegram bot is working correctly!

<b>Bot Token:</b> ${botToken.substring(0, 10)}...
<b>Chat ID:</b> ${chatId}
<b>Test Time:</b> ${new Date().toLocaleString()}

If you received this message, your setup is perfect! üéâ`;

            try {
                const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        parse_mode: 'HTML'
                    })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    addLog('‚úÖ Telegram connection test successful!', 'success');
                    document.getElementById('telegramStatus').textContent = 'Connected ‚úÖ';
                    document.getElementById('telegramStatus').style.color = '#10b981';
                } else {
                    addLog(`‚ùå Telegram test failed: ${data.description}`, 'error');
                    document.getElementById('telegramStatus').textContent = 'Error ‚ùå';
                    document.getElementById('telegramStatus').style.color = '#ef4444';
                }
            } catch (error) {
                addLog(`‚ùå Connection test failed: ${error.message}`, 'error');
                document.getElementById('telegramStatus').textContent = 'Failed ‚ùå';
                document.getElementById('telegramStatus').style.color = '#ef4444';
            }
        }

        function clearLogs() {
            document.getElementById('activityLog').innerHTML = '';
            addLog('Logs cleared', 'info');
        }

        function executeOpportunity() {
            addLog('TRADE EXECUTION: This would execute the trade in production', 'success');
            alert('üöÄ Trade execution simulation!\n\nIn production, this would:\n1. Buy USDT from exchange\n2. Transfer to P2P platform\n3. Create sell order\n4. Monitor completion\n5. Send profit confirmation');
        }

        function simulateOpportunity() {
            addLog('Running trade simulation...', 'info');
            setTimeout(() => {
                addLog('Simulation completed: Trade would be profitable', 'success');
            }, 2000);
        }

        async function debugTelegram() {
            addLog('üîß Starting Telegram debug...', 'info');
            
            const botToken = telegramConfig.botToken;
            const chatId = telegramConfig.chatId;
            
            addLog(`Bot Token: ${botToken}`, 'info');
            addLog(`Chat ID: ${chatId}`, 'info');
            
            const testMessage = 'Test message from USDT Arbitrage Bot ü§ñ';
            
            try {
                addLog('Making direct fetch to Telegram API...', 'info');
                
                const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
                addLog(`URL: ${url}`, 'info');
                
                const payload = {
                    chat_id: chatId,
                    text: testMessage
                };
                addLog(`Payload: ${JSON.stringify(payload)}`, 'info');
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                addLog(`Response status: ${response.status}`, 'info');
                addLog(`Response ok: ${response.ok}`, 'info');
                
                const data = await response.json();
                addLog(`Full response: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (data.ok) {
                    addLog('‚úÖ Debug test successful!', 'success');
                } else {
                    addLog(`‚ùå Debug failed: ${data.description}`, 'error');
                }
            } catch (error) {
                addLog(`‚ùå Debug error: ${error.message}`, 'error');
                addLog(`Error stack: ${error.stack}`, 'error');
            }
        }

        async function sendTestAlert() {
            addLog('Sending test Telegram alert...', 'info');
            
            const botToken = telegramConfig.botToken;
            const chatId = telegramConfig.chatId;
            
            const message = `üö® <b>TEST ALERT</b>

<b>üéØ Arbitrage Opportunity Found</b>

<b>Route:</b> CoinDCX ‚Üí Local P2P
<b>Profit:</b> 3.2%
<b>Amount:</b> ‚Çπ1,568
<b>Volume:</b> ‚Çπ49,000

<b>‚ö° Action Required:</b>
Execute within 15 minutes!

<b>Recommendation:</b>
1. Buy USDT on CoinDCX
2. Sell on Local P2P
3. Keep transaction under ‚Çπ50k (TDS optimized)

<i>Generated: ${new Date().toLocaleString()}</i>`;

            try {
                const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        parse_mode: 'HTML'
                    })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    addLog('‚úÖ Test alert sent successfully!', 'success');
                    // Update preview
                    const preview = document.getElementById('telegramPreview');
                    preview.innerHTML = `
                        <div class="telegram-header">ü§ñ USDT Arbitrage Bot</div>
                        <div>üö® <strong>TEST ALERT!</strong></div>
                        <div>Route: CoinDCX ‚Üí Local P2P</div>
                        <div>Profit: 3.2%</div>
                        <div>Amount: ‚Çπ1,568</div>
                        <div>Time: ${new Date().toLocaleTimeString()}</div>
                    `;
                } else {
                    addLog(`‚ùå Telegram error: ${data.description}`, 'error');
                }
            } catch (error) {
                addLog(`‚ùå Test alert failed: ${error.message}`, 'error');
            }
        }

        function showTelegramConfig() {
            document.getElementById('telegramConfigModal').style.display = 'block';
            // Pre-fill current values from global config
            document.getElementById('botTokenInput').value = telegramConfig.botToken;
            document.getElementById('chatIdInput').value = telegramConfig.chatId;
        }

        function closeTelegramConfig() {
            document.getElementById('telegramConfigModal').style.display = 'none';
        }

        function saveTelegramConfig() {
            const newBotToken = document.getElementById('botTokenInput').value;
            const newChatId = document.getElementById('chatIdInput').value;
            
            if (!newBotToken || !newChatId) {
                alert('‚ùå Please fill in both Bot Token and Chat ID');
                return;
            }
            
            // CRITICAL FIX: Actually update the global config
            telegramConfig.botToken = newBotToken;
            telegramConfig.chatId = newChatId;
            
            addLog(`üì± Telegram configuration updated`, 'success');
            addLog(`Bot Token: ${newBotToken.substring(0, 10)}...`, 'info');
            addLog(`Chat ID: ${newChatId}`, 'info');
            
            closeTelegramConfig();
            alert('‚úÖ Telegram configuration saved! Test the connection now.');
        }

        // Initialize
        window.onload = function() {
            updateExchangeRates();
            updateP2PPremiums();
            addLog('Dashboard initialized. Ready to start monitoring.', 'success');
        };
    </script>
</body>
</html>