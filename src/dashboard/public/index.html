<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treum Algotech - USDT Arbitrage Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .navbar {
            background-color: #1a1a2e !important;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-connected {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }
        .status-disconnected {
            background-color: #dc3545;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .price-up {
            color: #28a745;
        }
        .price-down {
            color: #dc3545;
        }
        .opportunity-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .metric-card {
            text-align: center;
            padding: 20px;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .metric-label {
            color: #6c757d;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                üöÄ Treum Algotech - USDT Arbitrage Bot
            </span>
            <span class="navbar-text">
                <span id="system-time"></span>
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Connection Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">System Status</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value" id="uptime">0h 0m</div>
                                    <div class="metric-label">Uptime</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value" id="opportunities-count">0</div>
                                    <div class="metric-label">Opportunities Today</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-value" id="avg-profit">0%</div>
                                    <div class="metric-label">Avg Profit</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div id="exchange-status">
                                        <div><span class="status-indicator status-disconnected" id="zebpay-status"></span> ZebPay</div>
                                        <div><span class="status-indicator status-disconnected" id="coindcx-status"></span> CoinDCX</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Prices -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Live Prices</h5>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Exchange</th>
                                    <th>Buy Price</th>
                                    <th>Sell Price</th>
                                    <th>Spread</th>
                                    <th>Updated</th>
                                </tr>
                            </thead>
                            <tbody id="price-table">
                                <tr>
                                    <td colspan="5" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Price Chart -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Price Chart (Last 30 min)</h5>
                        <canvas id="priceChart" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Opportunities -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Recent Arbitrage Opportunities</h5>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Route</th>
                                        <th>Buy Price</th>
                                        <th>Sell Price</th>
                                        <th>Profit</th>
                                        <th>Profit %</th>
                                        <th>Volume</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="opportunities-table">
                                    <tr>
                                        <td colspan="8" class="text-center">No opportunities yet</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Opportunity Alert -->
        <div id="opportunity-alert" class="row mb-4" style="display: none;">
            <div class="col-12">
                <div class="card opportunity-card">
                    <div class="card-body">
                        <h4 class="card-title">üö® Live Arbitrage Opportunity!</h4>
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Route:</strong> <span id="opp-route"></span>
                            </div>
                            <div class="col-md-3">
                                <strong>Profit:</strong> ‚Çπ<span id="opp-profit"></span>
                            </div>
                            <div class="col-md-3">
                                <strong>Profit %:</strong> <span id="opp-percent"></span>%
                            </div>
                            <div class="col-md-3">
                                <strong>Volume:</strong> ‚Çπ<span id="opp-volume"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Socket.IO connection
        const socket = io();
        
        // Chart setup
        const ctx = document.getElementById('priceChart').getContext('2d');
        const priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });

        // Price history for chart
        const priceHistory = {
            zebpay: [],
            coindcx: []
        };
        const maxDataPoints = 30;

        // Update system time
        setInterval(() => {
            document.getElementById('system-time').textContent = new Date().toLocaleString('en-IN');
        }, 1000);

        // Socket event handlers
        socket.on('update', (data) => {
            updateDashboard(data);
        });

        socket.on('opportunity', (opportunity) => {
            showOpportunityAlert(opportunity);
        });

        // Update dashboard with new data
        function updateDashboard(data) {
            // Update connection status
            updateConnectionStatus(data.connections);
            
            // Update prices
            updatePriceTable(data.prices);
            
            // Update opportunities
            updateOpportunitiesTable(data.opportunities);
            
            // Update metrics
            updateMetrics(data);
        }

        // Update connection status indicators
        function updateConnectionStatus(connections) {
            Object.entries(connections).forEach(([exchange, connected]) => {
                const indicator = document.getElementById(`${exchange}-status`);
                if (indicator) {
                    indicator.className = `status-indicator ${connected ? 'status-connected' : 'status-disconnected'}`;
                }
            });
        }

        // Update price table
        function updatePriceTable(prices) {
            const tbody = document.getElementById('price-table');
            tbody.innerHTML = '';
            
            prices.forEach(price => {
                const spread = ((price.sellPrice - price.buyPrice) / price.buyPrice * 100).toFixed(2);
                const time = new Date(price.timestamp).toLocaleTimeString('en-IN');
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${price.exchange.toUpperCase()}</td>
                    <td>‚Çπ${price.buyPrice.toFixed(2)}</td>
                    <td>‚Çπ${price.sellPrice.toFixed(2)}</td>
                    <td>${spread}%</td>
                    <td>${time}</td>
                `;
                
                // Update chart data
                updatePriceChart(price);
            });
        }

        // Update price chart
        function updatePriceChart(price) {
            const exchange = price.exchange.toLowerCase();
            if (!priceHistory[exchange]) {
                priceHistory[exchange] = [];
            }
            
            priceHistory[exchange].push({
                x: new Date(),
                y: price.buyPrice
            });
            
            // Keep only last N data points
            if (priceHistory[exchange].length > maxDataPoints) {
                priceHistory[exchange].shift();
            }
            
            // Update chart
            const datasets = [];
            const colors = {
                zebpay: 'rgb(75, 192, 192)',
                coindcx: 'rgb(255, 99, 132)'
            };
            
            Object.entries(priceHistory).forEach(([ex, data]) => {
                if (data.length > 0) {
                    datasets.push({
                        label: ex.toUpperCase(),
                        data: data,
                        borderColor: colors[ex] || 'rgb(54, 162, 235)',
                        tension: 0.1
                    });
                }
            });
            
            priceChart.data.datasets = datasets;
            priceChart.update('none');
        }

        // Update opportunities table
        function updateOpportunitiesTable(opportunities) {
            const tbody = document.getElementById('opportunities-table');
            tbody.innerHTML = '';
            
            if (opportunities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No opportunities yet</td></tr>';
                return;
            }
            
            opportunities.forEach(opp => {
                const time = new Date(opp.detected_at).toLocaleTimeString('en-IN');
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${time}</td>
                    <td>${opp.buy_exchange} ‚Üí ${opp.sell_exchange}</td>
                    <td>‚Çπ${parseFloat(opp.buy_price).toFixed(2)}</td>
                    <td>‚Çπ${parseFloat(opp.sell_price).toFixed(2)}</td>
                    <td>‚Çπ${parseFloat(opp.profit).toFixed(2)}</td>
                    <td class="${parseFloat(opp.profit_percent) > 0.5 ? 'price-up' : ''}">${parseFloat(opp.profit_percent).toFixed(2)}%</td>
                    <td>‚Çπ${parseInt(opp.volume).toLocaleString('en-IN')}</td>
                    <td>${opp.acted_upon ? '‚úÖ Acted' : '‚è≥ Pending'}</td>
                `;
            });
        }

        // Update metrics
        function updateMetrics(data) {
            // Update uptime
            const uptimeSeconds = data.timestamp ? Math.floor(Date.now() / 1000 - new Date(data.timestamp).getTime() / 1000) : 0;
            const hours = Math.floor(uptimeSeconds / 3600);
            const minutes = Math.floor((uptimeSeconds % 3600) / 60);
            document.getElementById('uptime').textContent = `${hours}h ${minutes}m`;
            
            // Update opportunities count
            if (data.opportunities) {
                document.getElementById('opportunities-count').textContent = data.opportunities.length;
                
                // Calculate average profit
                if (data.opportunities.length > 0) {
                    const avgProfit = data.opportunities.reduce((sum, opp) => sum + parseFloat(opp.profit_percent), 0) / data.opportunities.length;
                    document.getElementById('avg-profit').textContent = avgProfit.toFixed(2) + '%';
                }
            }
        }

        // Show opportunity alert
        function showOpportunityAlert(opportunity) {
            const alert = document.getElementById('opportunity-alert');
            document.getElementById('opp-route').textContent = `${opportunity.buyExchange} ‚Üí ${opportunity.sellExchange}`;
            document.getElementById('opp-profit').textContent = opportunity.profit.toFixed(2);
            document.getElementById('opp-percent').textContent = opportunity.profitPercent.toFixed(2);
            document.getElementById('opp-volume').textContent = opportunity.volume.toLocaleString('en-IN');
            
            alert.style.display = 'block';
            
            // Hide after 30 seconds
            setTimeout(() => {
                alert.style.display = 'none';
            }, 30000);
        }

        // Initial load
        fetch('/api/status')
            .then(res => res.json())
            .then(data => {
                updateDashboard({
                    connections: data.websocket,
                    prices: data.prices,
                    opportunities: data.opportunities,
                    timestamp: new Date()
                });
            });
    </script>
</body>
</html>