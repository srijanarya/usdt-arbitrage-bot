<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USDT Arbitrage Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f0f23;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #1a1a2e;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 3px solid #16213e;
        }

        h1 {
            text-align: center;
            color: #4fbdba;
            font-size: 2.5em;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1a1a2e;
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4444;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #44ff44;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: #1a1a2e;
            border-radius: 10px;
            padding: 25px;
            border: 1px solid #2a2a3e;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(79, 189, 186, 0.2);
        }

        .card h2 {
            color: #4fbdba;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .price-grid {
            display: grid;
            gap: 15px;
        }

        .price-item {
            background: #0f0f23;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #4fbdba;
        }

        .price-item.alert {
            border-left-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }

        .exchange-name {
            font-weight: bold;
            color: #7ec8e3;
        }

        .price-values {
            text-align: right;
        }

        .bid-price {
            color: #44ff44;
            font-size: 1.2em;
            font-weight: bold;
        }

        .ask-price {
            color: #ff4444;
            font-size: 1.2em;
            font-weight: bold;
        }

        .opportunity-card {
            background: linear-gradient(135deg, #1a472a 0%, #2a5a3a 100%);
            border: 2px solid #44ff44;
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(68, 255, 68, 0.3); }
            50% { box-shadow: 0 0 30px rgba(68, 255, 68, 0.5); }
        }

        .opportunity-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .detail-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
        }

        .detail-label {
            color: #888;
            font-size: 0.9em;
        }

        .detail-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #4fbdba;
        }

        .calculator {
            background: #2a2a3e;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .calculator-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            color: #888;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .input-group input, .input-group select {
            background: #1a1a2e;
            border: 1px solid #3a3a4e;
            color: #e0e0e0;
            padding: 10px;
            border-radius: 5px;
            font-size: 1em;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #4fbdba;
        }

        .calculate-btn {
            background: #4fbdba;
            color: #0f0f23;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
        }

        .calculate-btn:hover {
            background: #7ec8e3;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .result-item {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .result-label {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .result-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .result-value.profit {
            color: #44ff44;
        }

        .result-value.loss {
            color: #ff4444;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .history-table th {
            background: #2a2a3e;
            color: #4fbdba;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #3a3a4e;
        }

        .history-table td {
            padding: 12px;
            border-bottom: 1px solid #2a2a3e;
        }

        .history-table tr:hover {
            background: #1a1a2e;
        }

        .timestamp {
            color: #888;
            font-size: 0.9em;
        }

        .alert-message {
            background: #ffd700;
            color: #0f0f23;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
            display: none;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #888;
        }

        .spinner {
            border: 3px solid #2a2a3e;
            border-top: 3px solid #4fbdba;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üíπ USDT Arbitrage Dashboard</h1>
        </div>
    </header>

    <div class="container">
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Connecting...</span>
            </div>
            <div>
                <span id="lastUpdate">Last update: --:--:--</span>
            </div>
        </div>

        <div id="alertMessage" class="alert-message"></div>

        <div class="grid">
            <!-- Current Prices Card -->
            <div class="card">
                <h2>üìä Current Prices</h2>
                <div id="priceGrid" class="price-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading prices...</p>
                    </div>
                </div>
            </div>

            <!-- Best Opportunity Card -->
            <div class="card opportunity-card" id="opportunityCard" style="display: none;">
                <h2>üöÄ Best Opportunity</h2>
                <div class="opportunity-details" id="opportunityDetails">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Calculator Card -->
        <div class="card">
            <h2>üßÆ Arbitrage Calculator</h2>
            <div class="calculator">
                <div class="calculator-inputs">
                    <div class="input-group">
                        <label>Buy Price (‚Çπ)</label>
                        <input type="number" id="calcBuyPrice" placeholder="85.00" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>Sell Price (‚Çπ)</label>
                        <input type="number" id="calcSellPrice" placeholder="90.00" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>Amount (USDT)</label>
                        <input type="number" id="calcAmount" placeholder="100" value="100">
                    </div>
                    <div class="input-group">
                        <label>Exchange</label>
                        <select id="calcExchange">
                            <option value="zebpay">ZebPay</option>
                            <option value="coindcx">CoinDCX</option>
                            <option value="binance_p2p">Binance P2P</option>
                            <option value="kucoin">KuCoin</option>
                        </select>
                    </div>
                </div>
                <button class="calculate-btn" onclick="calculateArbitrage()">Calculate Profit</button>
                <div id="calcResults" class="result-grid" style="display: none;">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Recent Opportunities -->
        <div class="card">
            <h2>üìà Recent Arbitrage Opportunities</h2>
            <table class="history-table" id="historyTable">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Buy Exchange</th>
                        <th>Sell Exchange</th>
                        <th>Buy Price</th>
                        <th>Sell Price</th>
                        <th>Profit</th>
                        <th>ROI</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px; color: #888;">
                            No opportunities recorded yet
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let ws = null;
        let reconnectInterval = null;
        let prices = new Map();
        let opportunities = [];

        // Initialize WebSocket connection
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket connected');
                updateStatus(true);
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                updateStatus(false);
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(connectWebSocket, 5000);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        // Handle incoming WebSocket messages
        function handleWebSocketMessage(message) {
            const timestamp = new Date().toLocaleTimeString();
            document.getElementById('lastUpdate').textContent = `Last update: ${timestamp}`;

            switch (message.type) {
                case 'prices':
                    updatePrices(message.data);
                    break;
                case 'priceUpdate':
                    updateSinglePrice(message.data);
                    break;
                case 'arbitrage':
                    handleArbitrageOpportunity(message.data);
                    break;
            }
        }

        // Update status indicator
        function updateStatus(connected) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'Connected';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Disconnected';
            }
        }

        // Update all prices
        function updatePrices(priceData) {
            prices.clear();
            priceData.forEach(price => {
                prices.set(price.exchange, price);
            });
            renderPrices();
        }

        // Update single price
        function updateSinglePrice(priceData) {
            prices.set(priceData.exchange, priceData);
            renderPrices();
        }

        // Render price grid
        function renderPrices() {
            const priceGrid = document.getElementById('priceGrid');
            priceGrid.innerHTML = '';

            prices.forEach((price, exchange) => {
                const isAlert = price.ask < 85; // Alert for prices below ‚Çπ85
                
                const priceItem = document.createElement('div');
                priceItem.className = `price-item ${isAlert ? 'alert' : ''}`;
                priceItem.innerHTML = `
                    <div>
                        <div class="exchange-name">${exchange}</div>
                        <div class="timestamp">${new Date(price.timestamp).toLocaleTimeString()}</div>
                    </div>
                    <div class="price-values">
                        <div class="bid-price">Bid: ‚Çπ${price.bid.toFixed(2)}</div>
                        <div class="ask-price">Ask: ‚Çπ${price.ask.toFixed(2)}</div>
                    </div>
                `;
                priceGrid.appendChild(priceItem);
            });
        }

        // Handle arbitrage opportunity
        function handleArbitrageOpportunity(opportunity) {
            // Show opportunity card
            const oppCard = document.getElementById('opportunityCard');
            oppCard.style.display = 'block';
            
            const details = document.getElementById('opportunityDetails');
            details.innerHTML = `
                <div class="detail-item">
                    <div class="detail-label">Route</div>
                    <div class="detail-value">${opportunity.buyExchange} ‚Üí ${opportunity.sellExchange}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Buy Price</div>
                    <div class="detail-value">‚Çπ${opportunity.buyPrice.toFixed(2)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Sell Price</div>
                    <div class="detail-value">‚Çπ${opportunity.sellPrice.toFixed(2)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Net Profit</div>
                    <div class="detail-value profit">‚Çπ${opportunity.netProfit.toFixed(2)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">ROI</div>
                    <div class="detail-value profit">${opportunity.roi.toFixed(2)}%</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Status</div>
                    <div class="detail-value">üü¢ Active</div>
                </div>
            `;

            // Add to history
            opportunities.unshift(opportunity);
            if (opportunities.length > 20) {
                opportunities.pop();
            }
            updateHistory();

            // Show alert if high profit
            if (opportunity.netProfit > 500) {
                showAlert(`üöÄ High profit opportunity: ‚Çπ${opportunity.netProfit.toFixed(2)} on ${opportunity.buyExchange} ‚Üí ${opportunity.sellExchange}`);
            }
        }

        // Update history table
        function updateHistory() {
            const tbody = document.getElementById('historyBody');
            
            if (opportunities.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px; color: #888;">
                            No opportunities recorded yet
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = opportunities.map(opp => `
                <tr>
                    <td class="timestamp">${new Date(opp.timestamp).toLocaleTimeString()}</td>
                    <td>${opp.buyExchange}</td>
                    <td>${opp.sellExchange}</td>
                    <td>‚Çπ${opp.buyPrice.toFixed(2)}</td>
                    <td>‚Çπ${opp.sellPrice.toFixed(2)}</td>
                    <td class="${opp.netProfit > 0 ? 'profit' : 'loss'}">‚Çπ${opp.netProfit.toFixed(2)}</td>
                    <td class="${opp.roi > 0 ? 'profit' : 'loss'}">${opp.roi.toFixed(2)}%</td>
                </tr>
            `).join('');
        }

        // Show alert message
        function showAlert(message) {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 10000);
        }

        // Calculate arbitrage
        async function calculateArbitrage() {
            const buyPrice = document.getElementById('calcBuyPrice').value;
            const sellPrice = document.getElementById('calcSellPrice').value;
            const amount = document.getElementById('calcAmount').value;
            const exchange = document.getElementById('calcExchange').value;

            if (!buyPrice || !sellPrice) {
                showAlert('Please enter both buy and sell prices');
                return;
            }

            try {
                const response = await fetch(`/api/calculate?buyPrice=${buyPrice}&sellPrice=${sellPrice}&amount=${amount}&exchange=${exchange}`);
                const result = await response.json();
                
                const resultsDiv = document.getElementById('calcResults');
                resultsDiv.style.display = 'grid';
                resultsDiv.innerHTML = `
                    <div class="result-item">
                        <div class="result-label">Investment</div>
                        <div class="result-value">‚Çπ${result.investment.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Revenue</div>
                        <div class="result-value">‚Çπ${result.revenue.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Net Profit</div>
                        <div class="result-value ${result.profitable ? 'profit' : 'loss'}">‚Çπ${result.netProfit.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">ROI</div>
                        <div class="result-value ${result.profitable ? 'profit' : 'loss'}">${result.roi.toFixed(2)}%</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Min Quantity</div>
                        <div class="result-value">${result.meetsMinQuantity ? '‚úÖ Met' : '‚ùå Not Met'}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Status</div>
                        <div class="result-value">${result.profitable ? 'üü¢ Profitable' : 'üî¥ Not Profitable'}</div>
                    </div>
                `;
            } catch (error) {
                showAlert('Failed to calculate: ' + error.message);
            }
        }

        // Load recent opportunities on page load
        async function loadRecentOpportunities() {
            try {
                const response = await fetch('/api/opportunities');
                const data = await response.json();
                
                opportunities = data.map(opp => ({
                    buyExchange: opp.buy_exchange,
                    sellExchange: opp.sell_exchange,
                    buyPrice: opp.buy_price,
                    sellPrice: opp.sell_price,
                    netProfit: opp.net_profit,
                    roi: opp.profit_percentage,
                    timestamp: opp.detected_at
                }));
                
                updateHistory();
            } catch (error) {
                console.error('Failed to load opportunities:', error);
            }
        }

        // Initialize
        connectWebSocket();
        loadRecentOpportunities();

        // Auto-refresh opportunities every minute
        setInterval(loadRecentOpportunities, 60000);
    </script>
</body>
</html>